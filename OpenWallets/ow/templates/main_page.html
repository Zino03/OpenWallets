<!DOCTYPE html>
<html lang="ko">
{% extends 'base.html' %}

{% block title %}OpenWallets - 대시보드{% endblock %}
{% block subtitle %}재산 공개 대시보드{% endblock %}
{% block content %}
{% load humanize %}
<head>
    <meta charset="UTF-8">
    <title>OpenWallets - 메인</title>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: #f2f5fb;
            color: #002c6a;
        }
        .main {
            padding: 5px;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .card h2 {
            margin-top: 0;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        .chart {
            width: 100%;
            height: 200px;
            background: #dde8fb;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: #043b85;
        }

        .slider-wrapper {
            position: relative;
            width: 1000px; /* 카드 4개 * (170 + 2*10)px */
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slider-viewport {
            width: 900px;
            overflow: hidden;
            /* slider-page는 flex 컨테이너 */
        }

        .slider-page {
            display: flex;
            /* gap으로 카드 간격 조절 */
        }

        .slide-card {
            flex: 0 0 175px;
            background: #fff;
            border-radius: 10px;
            margin: 10px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        /* 버튼 */
        .slide-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            background: #043b85;
            color: white;
            border: none;
            font-size: 12px;
            font-weight: bold;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background 0.3s ease;
        }

        /* 왼쪽 버튼을 슬라이더 왼쪽 영역 밖으로 이동 (사이드바와 겹치지 않게) */
        #prevBtn {
            left: 0px;  /* 슬라이더 wrapper의 왼쪽 밖으로 */
        }

        /* 오른쪽 버튼도 슬라이더 오른쪽 밖으로 */
        #nextBtn {
            right: 10px;
        }

        a {
            text-decoration: none;
            color: black;
        }

        .region_name path,
        .region_name polygon,
        .region_name .st0 {
            fill: #cccccc;
            stroke: #ffffff;
            stroke-width: 1;
            cursor: pointer;
            transition: fill 0.3s;
        }

        .region_name:hover path,
        .region_name:hover polygon,
        .region_name:hover .st0 {
            fill: #ffcc00;
        }

        .region_name.selected path,
        .region_name.selected polygon,
        .region_name.selected .st0 {
            fill: #ff6600;
        }
    </style>
</head>
<body>
    <div class="main">
        <div class="card">
            <h2>2025-04-07 기준 상위 의원 재산</h2>
            <div class="slider-wrapper">
                <button class="slide-btn" id="prevBtn">&#10094;</button>
                <div class="slider-viewport">
                    {% for page in chunked_members %}
                    <div class="slider-page" style="display: {% if forloop.first %}flex{% else %}none{% endif %}; gap: 10px;">
                        {% for item in page %}
                            <div class="slide-card">
                                <strong>{{ item.rank }}.</strong> <a href="{% url 'member_info' item.member.member_id %}">{{ item.member.name }}</a><br>
                                총 재산: {{ item.member.total_assets|intcomma }}
                            </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
                <button class="slide-btn" id="nextBtn">&#10095;</button>
            </div>
        </div>
    <script>
        const pages = document.querySelectorAll('.slider-page');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        let currentPage = 0;
        const maxPage = pages.length - 1;

        function showPage(index) {
            pages.forEach((page, i) => {
                page.style.display = (i === index) ? 'flex' : 'none';
            });
        }

        nextBtn.addEventListener('click', () => {
            if (currentPage < maxPage) {
                currentPage++;
                showPage(currentPage);
            }
        });

        prevBtn.addEventListener('click', () => {
            if (currentPage > 0) {
                currentPage--;
                showPage(currentPage);
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- 지역별 카드 -->
        <div class="card region-card" style="flex:1;">
            <h3>지역별 총 자산</h3>
            <select id="regionSelect">
                <option value="">-- 지역 선택 --</option>
                {% for region in regions %}
                <option value="{{ region }}">{{ region }}</option>
                {% endfor %}
            </select>
            <div id="regionAssetDisplay" style="margin-top:10px; font-weight:bold;">
                <!-- 선택한 지역 자산 금액 -->
            </div>

            <div id="map-container" style="width: 100%; max-width: 400px; height: 300px;">
                {% include 'svg/korea_map.svg' %}
            </div>
            <div id="regionTop4" style="margin-top:15px;">
                <!-- 선택 지역 상위 4명 의원 목록 -->
            </div>
            <div style="width: 100%; max-width: 400px; height: 300px;">
                <canvas id="regionPieChart" width="200" height="200"></canvas>
                <script>
                    const regionCtx = document.getElementById('regionPieChart').getContext('2d');
                    const regionPieChart = new Chart(regionCtx, {
                        type: 'pie',
                        data: {
                            labels: {{ regions|safe }},
                            datasets: [{
                                label: '지역별 재산 총합',
                                data: {{ region_asset_values|safe }},
                                backgroundColor: [
                                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                                    '#C9CBCF', '#E7E9ED', '#B39DDB', '#90CAF9'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.raw.toLocaleString();
                                            return `${context.label}: ${value} 원`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                </script>
            </div>
        </div>

        <!-- 정당별 카드 -->
        <div class="card party-card" style="flex:1;">
            <h3>정당별 총 자산</h3>
            <select id="partySelect">
                <option value="">-- 정당 선택 --</option>
                {% for party in parties %}
                <option value="{{ party }}">{{ party }}</option>
                {% endfor %}
            </select>
            <div id="partyAssetDisplay" style="margin-top:10px; font-weight:bold;">
                <!-- 선택한 정당 자산 금액 -->
            </div>
            <div id="partyTop4" style="margin-top:15px;">
                <!-- 선택 정당 상위 4명 의원 목록 -->
            </div>
            <div style="width: 100%; max-width: 400px; height: 300px;">
                <canvas id="partyPieChart" width="200" height="200"></canvas>
                <script>
                    const partyCtx = document.getElementById('partyPieChart').getContext('2d');
                    const partyPieChart = new Chart(partyCtx, {
                        type: 'pie',
                        data: {
                            labels: {{ parties|safe }},
                            datasets: [{
                                label: '정당별 재산 총합',
                                data: {{ party_asset_values|safe }},
                                backgroundColor: [
                                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                                    '#C9CBCF', '#E7E9ED', '#B39DDB', '#90CAF9'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.raw.toLocaleString();
                                            return `${context.label}: ${value} 원`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                </script>
            </div>
        </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
        // 데이터 JSON화 (views.py에서 넘긴 context 사용)
        const regionAssets = {{ region_assets|safe }};
        const partyAssets = {{ party_assets|safe }};
        
        // top4 데이터도 미리 넘겨서 사용 (views.py에서 JSON 직렬화 후 전달 필요)
        // 예시:
        // regionTop4Data = { '충북': [{name:'김아무개', total_assets:123456}, ...], ... }
        // partyTop4Data = { '국민의힘': [{name:'박아무개', total_assets:654321}, ...], ... }
        const regionTop4Data = {{ region_top4|safe }};
        const partyTop4Data = {{ party_top4|safe }};

        const regionSelect = document.getElementById('regionSelect');
        const regionDisplay = document.getElementById('regionAssetDisplay');
        const regionTop4Div = document.getElementById('regionTop4');

        const partySelect = document.getElementById('partySelect');
        const partyDisplay = document.getElementById('partyAssetDisplay');
        const partyTop4Div = document.getElementById('partyTop4');

        function renderTop4(list, container) {
            if (!list || list.length === 0) {
                container.innerHTML = '<em>데이터가 없습니다.</em>';
                return;
            }
            let html = '<ol>';
            list.forEach(item => {
                html += `<li>${item.name}</br>총 재산: ${item.total_assets.toLocaleString()}</li>`;
            });
            html += '</ol>';
            container.innerHTML = html;
        }

        regionSelect.addEventListener('change', () => {
            const mapContainer = document.getElementById('map-container');
            const selected = regionSelect.value;
            mapContainer.querySelectorAll('.region_name').forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.name === selected) {
                    el.classList.add('selected');
                    console.log("하이라이트 적용:", el.dataset.name);
                }
            }); 

            if (selected && regionAssets[selected]) {
                regionDisplay.textContent = `${selected} 총 재산: ${regionAssets[selected].toLocaleString()}`;
                renderTop4(regionTop4Data[selected], regionTop4Div);
            } else {
                regionDisplay.textContent = '';
                regionTop4Div.innerHTML = '';
            }
        });

        partySelect.addEventListener('change', () => {
            const selected = partySelect.value;
            if (selected && partyAssets[selected]) {
                partyDisplay.textContent = `${selected} 총 재산: ${partyAssets[selected].toLocaleString()}`;
                renderTop4(partyTop4Data[selected], partyTop4Div);
            } else {
                partyDisplay.textContent = '';
                partyTop4Div.innerHTML = '';
            }
        });
        });
    </script>
    </div>
</body>
{% endblock %}
</html>